import"./_commonjsHelpers-9f0e44cc.js";import{g as Ne,a as Ke,s as Ve,T as f,r as u,u as qe,_ as Be,j as e,b as Ue,c as ze,d as He,C as ee,B as $,e as E,i as R,f as w,h as y,L as I,k as x,l as te,m as v,I as A,P as ne,F as We,n as ae,o as F,p as Ge,D as N,q as xe,t as Xe,v as je,w as Ye,S as ge,x as Je,R as Ze,Q as et,y as tt,z as nt,A as at}from"./debounce-02451237.js";import{C as be,a as we,b as Ce,u as b,A as st,c as M,d as ot,S as K,e as rt,f as it,Q as lt,g as ct,M as dt}from"./AddCircleOutline-f0a69d24.js";import{u as B,a as ut,b as se,c as U,L as z,d as Se,e as V,f as mt,C as _e,g as ht,T as oe,h as xt,i as p,j as gt,k as pt,l as H,V as Q,r as ft,m as yt,n as vt,D as jt,o as bt,p as wt,t as q,q as Ct,s as St,v as _t,F as Dt,O as kt,N as J,w as pe,x as $t,R as Pt,y as Tt,z as Et}from"./Calendar-685327fa.js";import{d as _}from"./utc-1e73b667.js";function Rt(t){return Ne("MuiAlertTitle",t)}Ke("MuiAlertTitle",["root"]);const Mt=["className"],Lt=t=>{const{classes:n}=t;return He({root:["root"]},Rt,n)},At=Ve(f,{name:"MuiAlertTitle",slot:"Root",overridesResolver:(t,n)=>n.root})(({theme:t})=>({fontWeight:t.typography.fontWeightMedium,marginTop:-2})),Ft=u.forwardRef(function(n,a){const o=qe({props:n,name:"MuiAlertTitle"}),{className:s}=o,r=Be(o,Mt),i=o,c=Lt(i);return e.jsx(At,Ue({gutterBottom:!0,component:"div",ownerState:i,ref:a,className:ze(c.root,s)},r))}),Qt=Ft;function fe(){const t=B(),n=ut();return console.error(n),e.jsx(ee,{maxWidth:"sm",children:e.jsxs(be,{variant:"outlined",sx:{mt:6},children:[e.jsx(f,{variant:"h5",sx:{backgroundColor:"#f205",p:"0.5rem"},children:"Unable to resolve request"}),e.jsxs(we,{children:[e.jsx("p",{children:"An error has occurred: "}),e.jsx("div",{style:{backgroundColor:"#111",padding:"0.5rem",borderRadius:"4px",wordWrap:"break-word",fontFamily:"monospace"},children:n.statusText||n.message})]}),e.jsx(Ce,{children:e.jsx($,{onClick:()=>t(-1),children:"Back"})})]})})}var re={},Ot=R;Object.defineProperty(re,"__esModule",{value:!0});var De=re.default=void 0,It=Ot(E()),Nt=e,Kt=(0,It.default)((0,Nt.jsx)("path",{d:"M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"}),"Home");De=re.default=Kt;var ie={},Vt=R;Object.defineProperty(ie,"__esModule",{value:!0});var ke=ie.default=void 0,qt=Vt(E()),Bt=e,Ut=(0,qt.default)((0,Bt.jsx)("path",{d:"M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-7 2h2.5v12H13V6zm-2 12H8.5V6H11v12zM4 6h2.5v12H4V6zm16 12h-2.5V6H20v12z"}),"CalendarViewWeek");ke=ie.default=Ut;var le={},zt=R;Object.defineProperty(le,"__esModule",{value:!0});var $e=le.default=void 0,Ht=zt(E()),Wt=e,Gt=(0,Ht.default)((0,Wt.jsx)("path",{d:"M3 17h18v2H3zm0-7h18v5H3zm0-4h18v2H3z"}),"CalendarViewDay");$e=le.default=Gt;function Pe({route:t,children:n}){const a=se(),o=U(),s=w(),r=a.pathname===t&&!o.location||o.location&&o.location.pathname===t,i=new URLSearchParams(o.location&&o.location.search||"v="),c=new URLSearchParams(a.search||"v="),l=i.get("v"),d=c.get("v"),h=r&&!l&&!d,C=o.location&&o.location.pathname===t&&!l,j=a.pathname===t&&!d;return e.jsx(z,{disablePadding:!0,children:e.jsx(Se,{component:V,to:t,sx:{backgroundColor:j?Ee:r?Te:void 0,boxShadow:(C||h)&&"4px 0 0 inset "+y(s.palette.primary.main,.53),pr:"0.25rem",color:y(s.palette.text.primary,r?1:.775)},children:n})})}const Te="#0116",Ee="#153244cc";function Xt({route:t,title:n}){const a=se(),o=U(),s=w(),[r]=mt(),i=r.has("d")?"&d="+r.get("d"):"",c=a.pathname===t&&!o.location||o.location&&o.location.pathname===t;return e.jsx(z,{disablePadding:!0,children:e.jsxs(I,{disablePadding:!0,sx:{color:y(s.palette.text.primary,c?1:.775),width:"100%",maxWidth:360,bgcolor:"background.paper",borderBottom:c?"1px solid #ffffff28":"1px solid #0008"},"aria-label":`Nested folder ${t}`,children:[e.jsx(Pe,{route:t,children:e.jsx(x,{sx:{textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap"},children:n})}),e.jsx(_e,{in:c,timeout:350,unmountOnExit:!0,children:e.jsxs(I,{disablePadding:!0,children:[e.jsx(Y,{to:`${t}?v=month${i}`,label:"Month",children:e.jsx(ht,{})}),e.jsx(Y,{to:`${t}?v=week${i}`,label:"Week",children:e.jsx(ke,{})}),e.jsx(Y,{to:`${t}?v=day${i}`,label:"Day",children:e.jsx($e,{})})]})})]})})}function Y({to:t="",label:n,children:a}){const o=w(),s=U(),r=se(),i=u.useContext(oe),c=t.split("?")[0],l=s.location&&s.location.pathname,d=r.pathname,h=new URLSearchParams(t.split("?")[1]||"v="),C=new URLSearchParams(s.location&&s.location.search||"v="),j=new URLSearchParams(r.search||"v="),g=h.get("v"),S=C.get("v"),D=j.get("v"),k=l===c&&g===S,P=c===d&&g===D;return e.jsx(z,{onClick:()=>i(!1),sx:{color:"inherit",boxShadow:(k||P&&!s.location)&&"4px 0 0 inset "+y(o.palette.primary.main,.53),backgroundColor:P?Ee:Te},disablePadding:!0,children:e.jsxs(Se,{component:V,to:t,sx:{pl:3,"&:hover":{backgroundColor:"#aef3"}},children:[e.jsx(xt,{sx:{minWidth:"48px"},children:a}),n]})})}var ce={},Yt=R;Object.defineProperty(ce,"__esModule",{value:!0});var Re=ce.default=void 0,Jt=Yt(E()),Zt=e,en=(0,Jt.default)((0,Zt.jsx)("path",{d:"m17 7-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"}),"Logout");Re=ce.default=en;function de(){return te({staleTime:2*60*1e3,queryKey:["heartbeat"],queryFn:({signal:t})=>p("me",{signal:t})})}function tn({children:t}){var l;const n=v(),a=B(),o=w(),s=b({mutationFn:()=>(n.cancelQueries(),p("login",{timeout:5e3,method:"POST",body:{email:"Demo Account",password:"123"}})),onSuccess:d=>{console.log("mutation success with data: ",d),n.invalidateQueries({queryKey:["catalog"]}),n.setQueryData(["heartbeat"],d),a("/catalog")}}),r=b({mutationFn:()=>p("login",{timeout:5e3,method:"DELETE"}),onSuccess:d=>{console.log("logout mutation yielded ",d),n.cancelQueries(),n.setQueryData(["heartbeat"],null),a("/login")}}),i=de();let c=e.jsx(x,{sx:{mx:"auto"},children:e.jsx(M,{size:"1.75rem"})});return!s.isPending&&!r.isPending&&(c=(l=i.data)!=null&&l.name?e.jsxs(e.Fragment,{children:[e.jsx(st,{sx:{bgcolor:o.palette.primary.main,mr:1,ml:1,width:"30px",height:"30px"},children:i.data.name[0]}),e.jsx("span",{style:{overflow:"hidden",flexGrow:1,whiteSpace:"nowrap",textOverflow:"ellipsis",verticalAlign:"center"},children:i.data.name}),e.jsx(A,{onClick:r.mutate,children:e.jsx(Re,{})})]}):e.jsx($,{variant:"contained",onClick:s.mutate,sx:{mx:"auto"},children:"Login Sample User"})),e.jsxs(e.Fragment,{children:[i.data&&t,e.jsx(I,{disablePadding:!0,sx:{mt:"auto"},children:e.jsx(z,{sx:{backgroundColor:"#0002",py:1,borderTop:"1px solid #0004"},disablePadding:!0,children:e.jsx(x,{sx:{width:"100%",display:"flex",height:"2.5rem",alignItems:"center"},children:c})})})]})}var ue={},nn=R;Object.defineProperty(ue,"__esModule",{value:!0});var Me=ue.default=void 0,an=nn(E()),sn=e,on=(0,an.default)((0,sn.jsx)("path",{d:"M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"}),"Share");Me=ue.default=on;function rn({query:t}){const n=w();if(t.isPending)return e.jsx(x,{sx:{boxShadow:"0 0 1rem inset "+y(n.palette.primary.main,.08),height:"100%",display:"grid",placeContent:"center"},children:e.jsx(M,{})});if(t.error)return e.jsx(x,{sx:{boxShadow:"0 0 1rem inset "+y(n.palette.primary.main,.08),height:"100%",display:"grid",placeContent:"center"},children:e.jsxs(ot,{severity:"error",sx:{border:"1px solid "+y(n.palette.error.main,.08)},action:e.jsx($,{sx:{mt:"auto"},onClick:t.refetch,children:"Retry"}),children:[e.jsx(Qt,{children:"Error"}),t.error.message]})})}function ln(t){return t.isPending||t.error?e.jsx(rn,{query:t}):!1}function Le({tag:t}){const{palette:n}=w(),[a,o]=u.useState(!1),[s,r]=u.useState(0),[i,c]=u.useState(0),l=gt(t);return u.useEffect(()=>{l.length&&(o(!0),c(Math.random()),r(l.length),pt(t))},[l,t]),e.jsx(cn,{open:a,children:e.jsx(ne,{elevation:0,sx:{px:2,py:1.25},children:e.jsx(f,{variant:"subtitle2",color:y(n.text.primary,.85),children:`Updated with ${s} remote change${s>1?"s":""}.`})})},i)}function cn({sx:t,open:n,children:a}){const[o,s]=u.useState(!0),r=H();return u.useEffect(()=>{const i=setTimeout(()=>{s(!1)},3e3);return()=>clearTimeout(i)},[]),n&&e.jsx(x,{sx:{pointerEvents:"none",zIndex:4,right:0,bottom:0,mr:3,position:r?"fixed":"absolute",mb:r?"4rem":"1rem",...t},children:e.jsx(We,{in:o,timeout:{enter:250,exit:1700},children:a})})}function Ae(t){return{staleTime:1*60*1e3,queryKey:["catalog"],queryFn:async()=>{const n=await p("calendars"),a=t.getQueryData(["catalog"])??[];return ft({localData:a,serverData:n,key:"calendar_id",tag:"calendars"})}}}const dn=t=>({request:n,params:a})=>(t.prefetchQuery(Ae(t)),"unused");function L({sx:t}){return e.jsxs(x,{sx:t,children:[e.jsx(K,{variant:"rounded",height:"2rem",animation:"wave",sx:{mb:1}}),e.jsx(K,{variant:"rounded",sx:{height:"calc(100% - 3rem)"}})]})}function ye({children:t}){return e.jsx(x,{sx:{gridAutoFlow:"row",display:"grid",width:"100%",padding:2,gap:2,gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gridAutoRows:"300px"},children:t})}function me({sx:t,children:n}){return e.jsx(be,{sx:{display:"flex",flexDirection:"column",boxShadow:"0.25rem 0.25rem 0.35rem #0006",...t},children:n})}function un(){const t=mn(),[n,a]=u.useState(!1);return e.jsx(me,{children:e.jsxs(rt,{disabled:n,onClick:()=>{a(!0),setTimeout(()=>a(!1),500),t()},sx:{display:"flex",flexDirection:"column",flexGrow:1,opacity:n?.3:1},children:[e.jsx(it,{sx:{width:"80px",height:"80px"}}),e.jsx(f,{variant:"subtitle1",children:"New Calendar"})]})})}function mn(){const t=v(),[n,a]=u.useState(()=>o());function o(){return String(Math.floor(Math.random()*1e9))}return()=>{const s={summary:"Temporary Calendar",etag:"creating",calendar_id:n,stableKey:n};console.log("creating with idemKey: ",s.calendar_id),t.setQueryData(["catalog"],i=>[...i,s]);const r=o();console.log("setting new idem key to ",r),a(r)}}function hn(t){const n=v();return()=>{n.setQueryData(["catalog"],a=>a.map(o=>o.calendar_id===t?{...o,isDeleting:!0,unsaved:Date.now()}:o))}}function xn(t){const n=v();return a=>{n.setQueryData(["catalog"],o=>o.map(s=>s.calendar_id===t?{...s,...a,unsaved:Date.now()}:s))}}const gn=ae`
  from {
    box-shadow: 0 0 3rem #afff inset;
  }
  to {
    box-shadow: 0 0 3rem #aff0 inset;
  }
`,pn=ae`
from {
  opacity: 1.0;
  box-shadow: 0 0 0px #0000 inset;
}
to {
  opacity: 0.0;
  box-shadow: 0 0 200px #000f inset;
}
`;function fn({calendar:t,children:n}){const a=hn(t.calendar_id),o=xn(t.calendar_id),s=w(),[r,i]=u.useState(!1),c=t.etag==="creating",l=u.useRef(null),h=_().diff(t.created)<1e3,C=t.isDeleting&&t.unsaved-Date.now()<1e3;u.useEffect(()=>{var g,S;r&&((g=l.current)==null||g.focus(),(S=l.current)==null||S.select())},[r]);let j;return h&&(j=`${gn} 1s ease`),C&&(j=`${pn} 1s ease`),e.jsxs(me,{sx:{opacity:t.isDeleting?.5:void 0,animation:j},children:[e.jsx(x,{component:r||c?"div":V,to:"/calendars/"+t.calendar_id,sx:{color:"inherit",textDecoration:"none",bgcolor:y(s.palette.primary.dark,.3),"&:hover":{bgcolor:!c&&y(s.palette.primary.dark,.7)}},children:e.jsx(x,{sx:{height:"4rem",px:r?0:"12px",pt:r?0:"25px"},children:r?e.jsx(F,{sx:{width:"100%"},variant:"filled",inputRef:l,defaultValue:t.summary||"Untitled",onClick:g=>{r&&(g.preventDefault(),console.log("TextField preventDefault"))},onKeyUp:g=>{g.key==="Enter"&&l.current.blur()},onBlur:g=>{console.log("☁️ Blur: e.target.value=",g.target.value),o({summary:g.target.value}),i(!1)}}):e.jsx(x,{sx:{textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap"},children:t.summary})})}),e.jsx(we,{sx:{flexGrow:1,width:"100%"},children:n}),e.jsxs(Ce,{children:[e.jsx($,{disabled:c,component:V,to:`/calendars/${t.calendar_id}`,children:"Open"}),e.jsxs(x,{ml:"auto",children:[e.jsx(A,{disabled:c,"aria-label":"Share",onClick:()=>console.log("share placeholder"),children:e.jsx(Me,{sx:{opacity:.9}})}),e.jsx(A,{"aria-label":"Rename",onClick:()=>{console.log("renaming..."),i(!0)},children:e.jsx(yt,{sx:{opacity:.9}})}),e.jsx(A,{"aria-label":"Delete",disabled:t.isDeleting,onClick:()=>a(t.calendar_id),children:e.jsx(Ge,{sx:{opacity:.9}})})]})]})]})}function he(){const t=v();return te(Ae(t))}function yn(){var r,i,c;const t=he(),n=ln(t),a=e.jsx(vt,{children:e.jsx(f,{variant:"h6",component:"span",children:"My Calendars"})});if(t.isPending||t.isError&&t.isFetching||!t.data&&t.isFetching)return e.jsxs(Q,{children:[a,e.jsxs(ye,{children:[e.jsx(L,{sx:{opacity:.8}}),e.jsx(L,{sx:{opacity:.45}}),e.jsx(L,{sx:{opacity:.225}}),e.jsx(L,{sx:{opacity:.1}})]})]});if(t.error||!t.data)return e.jsxs(Q,{children:[a,n]});let o=[];((r=t.data)==null?void 0:r.length)<3&&(o=new Array(3-t.data.length).fill(null).map((l,d)=>e.jsx(me,{sx:{opacity:0}},d)));const s=_();return e.jsxs(Q,{children:[a,e.jsxs(ye,{children:[(c=(i=t.data)==null?void 0:i.map)==null?void 0:c.call(i,l=>e.jsxs(fn,{calendar:l,children:[e.jsxs(f,{variant:"body2",sx:{opacity:.5},children:["Created: ",_(l.created).from(s),e.jsx("br",{}),"Updated: ",_(l.updated).from(s),e.jsx("br",{}),e.jsxs("span",{style:{color:l.etag==="creating"?"green":void 0},children:["etag: ",l.etag]}),e.jsx("br",{}),"“",l.summary,"”"]}),e.jsxs(f,{variant:"body2",children:[l.unsaved&&e.jsxs(e.Fragment,{children:[e.jsxs("span",{style:{color:"#88f"},children:["Unsaved: ",l.unsaved]}),e.jsx("br",{})]}),l.isDeleting&&e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{color:"red"},children:"isDeleting"}),e.jsx("br",{})]}),l.originTag&&e.jsxs(e.Fragment,{children:[e.jsxs("span",{style:{color:"orange"},children:["originTag: ",l.originTag]}),e.jsx("br",{})]}),l.stableKey&&e.jsxs(e.Fragment,{children:[e.jsxs("span",{style:{color:"thistle"},children:["stableKey: ",l.stableKey]}),e.jsx("br",{})]})]})]},l.stableKey??l.calendar_id)),e.jsx(un,{}),o]}),e.jsx(Le,{tag:"calendars"})]})}function vn(){const t=Array(5).fill(0);return e.jsx(x,{sx:{flexGrow:1,overflowY:"auto",overflowX:"hidden",p:2,display:"flex",flexDirection:"column"},children:t.map((n,a)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",height:"40px"},children:[e.jsx(K,{variant:"rounded",width:16,height:16,sx:{display:"inline-block",mr:1}}),e.jsx(K,{sx:{display:"inline-block",flexGrow:1}})]},a))})}function jn(){var n;const t=he();return t.isPending?e.jsx(vn,{}):e.jsx(x,{sx:{flexGrow:1,overflowY:"auto",overflowX:"hidden"},children:e.jsxs(I,{disablePadding:!0,children:[t.data&&e.jsxs(Pe,{route:"/catalog",children:[e.jsx(De,{sx:{mr:1}}),"All Calendars"]}),(n=t.data)==null?void 0:n.map(a=>{const o=a.stableKey??a.calendar_id;if(!(a.isDeleting||a.etag==="creating"))return e.jsx(Xt,{route:`/calendars/${a.calendar_id}`,title:a.summary},o)})]})})}function bn(){return e.jsxs(e.Fragment,{children:[e.jsxs(x,{sx:{height:"64px",px:2,py:2,backgroundImage:`url(${bt})`,backgroundColor:"#00182575"},children:[e.jsx(wt,{sx:{transform:"translateY(5px)",mr:1,opacity:.75}}),e.jsx(f,{variant:"h6",component:"span",sx:{fontWeight:500,textShadow:"2px -1px 4px #000"},children:"Clear"}),e.jsx(f,{variant:"h6",component:"span",sx:{fontWeight:300,opacity:.9,textShadow:"1px -1px 4px #000"},children:"Time"})]}),e.jsx(N,{})]})}function wn({width:t="240px",expand:n}){const a=w(),o=H(),s=u.useContext(oe),r=e.jsxs(e.Fragment,{children:[e.jsx(bn,{}),e.jsx(tn,{children:e.jsx(jn,{})})]});return o?e.jsxs(jt,{open:n,onClose:()=>s(!1),sx:{"& .MuiDrawer-paper":{width:t,flexShrink:0,borderRight:`1px solid ${a.palette.divider}`,backgroundImage:"unset",backgroundColor:"#101b1d"}},children:[r,e.jsx(N,{})]}):e.jsx(ne,{component:"nav",elevation:0,sx:{display:"flex",flexDirection:"column",width:t,flexShrink:0,borderRight:`1px solid ${a.palette.divider}`,borderLeft:`1px solid ${a.palette.divider}`},children:r})}const Cn=()=>{};function Fe({mutate:t,data:n,isFetching:a,isError:o,getTouchList:s,debounceKey:r,log:i=Cn}){const c=u.useRef(1),l=v();u.useEffect(()=>{xe(r,()=>{const d=s(l);c.current++,d.length>0?(i(`♻️ Autosaving... (check # ${c.current})`),t(d)):i(`✅ Autosaver clean. (check # ${c.current})`)},4e3)()},[n,l,t,i,s,r]),u.useEffect(()=>{if(!a&&!o){if(i(`👁️ fetch success. ${Math.floor(Math.random()*1e9)}`),Xe(r)){i("Autosaver already ran or running.");return}xe(r,()=>{const d=s(l);d.length>0?(i("♻️👁️ Fetch sentinel syncing..."),t(d)):i("✅👁️ Fetch sentinel clean.")},4e3)()}},[l,t,a,o,i,s,r])}const Sn=ae`
  0% {
    opacity: 1.0;
  }
  50% {
    opacity: 0.0;
  }
  100% {
    opacity: 0.0;
  }
`;function Qe({touchList:t,isPending:n,label:a}){const[o,s]=u.useState(!1),r=t.length===0;u.useEffect(()=>{if(!r)return s(!0);const l=setTimeout(()=>{s(!1)},3e3);return()=>{clearTimeout(l)}},[r]);let i="success.main",c=`${a} saved.`;return t.length>0&&(i="info.main",c=`Unsaved (${t.length})`),n&&t.length>0&&(i="warning.main",c=`Saving... (${t.length})`),e.jsxs(x,{sx:{backgroundColor:"#222a",borderRadius:"4px",display:o?"flex":"none",justifyContent:"end",padding:"0.5rem 0.75rem",mr:2,mb:2,animation:r&&`${Sn} 2s ease 2s`},children:[e.jsx(f,{variant:"subtitle2",color:i,children:c}),n&&e.jsx(M,{size:"18px",sx:{ml:"1rem",color:i,alignSelf:"center"}})]})}function _n(){const t=u.useRef(new AbortController),n=v(),a=b({onMutate:s=>(console.log("initiating item mutation with variables=",s),{...s}),mutationFn:s=>(console.log("fetching item mutation with unsaved=",s.unsaved),$n(s)),onSuccess:(s,r,i)=>{console.log("item success, variables=",r),console.log("and context=",i),kn({result:s,original:r,queryClient:n})},onError:(s,r,i)=>{console.log("item error, unsaved=",r.unsaved),console.log("and context=",i),Dn({error:s,original:r,queryClient:n})}});return b({retry:0,mutationKey:["catalog bundle"],onMutate:s=>{t.current.abort(),t.current=new AbortController,console.log(`🟧 Starting bundle mutation with calendars (${s.length})`,s.map(r=>r.calendar_id).join(", "),"and variables=",...s)},mutationFn:s=>Promise.all(s.map(r=>a.mutateAsync({...r,signal:t.current.signal}))),onError:s=>{(s==null?void 0:s.status)===409&&(console.log(`⛔ Bundle mutation resulted in ${s.status}. Backoff-refetching...`),je("catalog conflict refetch",()=>{console.log("⛔ Bundle refetching."),n.refetchQueries({queryKey:["catalog"]})}))}})}function Dn({error:t,original:n,queryClient:a}){if(n.isDeleting&&t.status===404){a.setQueryData(["catalog"],o=>o.filter(s=>s.calendar_id!==n.calendar_id));return}}function kn({result:t,original:n,queryClient:a}){const o=a.getQueryData(["catalog"]).find(i=>i.calendar_id===n.calendar_id);function s(i,c){return i.summary===c.summary}if(n.etag==="creating"){const i={...o,primary_author_id:t.primary_author_id,etag:t.etag,created:t.created,updated:t.updated,calendar_id:t.calendar_id};s(t,o)?(console.log("🔗 content equivalent, clearing unsaved:",n.unsaved),delete i.unsaved):console.log("✖️ content mismatch:",o==null?void 0:o.summary,t.summary),a.setQueryData(["catalog"],c=>c.map(l=>l.calendar_id===n.calendar_id?i:l));return}if(n.isDeleting){a.setQueryData(["catalog"],i=>i.filter(c=>c.calendar_id!==n.calendar_id));return}if(o.etag!==n.etag)return;let r={};o.unsaved===n.unsaved?r={...t[0],stableKey:o.stableKey}:r={...o,etag:t[0].etag},a.setQueryData(["catalog"],i=>i.map(c=>c.calendar_id===n.calendar_id?r:c))}function $n(t){const n="calendars",o=t.signal,s={signal:void 0,unsaved:void 0,created:void 0,updated:void 0,originTag:void 0,stableKey:void 0,primary_author_id:void 0};return t.isDeleting?p(`${n}/${t.calendar_id}`,{method:"DELETE",body:{etag:t.etag},timeout:5e3,signal:o}):t.etag==="creating"?p(n,{method:"POST",body:{...t,...s,etag:void 0,key:t.calendar_id},timeout:5e3,signal:o}):p(`${n}/${t.calendar_id}`,{method:"PUT",body:{...t,...s},timeout:5e3,signal:o})}const Pn=t=>q(t.getQueryData(["catalog"]));function Tn(){const t=_n(),{data:n,isFetching:a,isError:o}=he(),s=q(n);return e.jsxs(e.Fragment,{children:[e.jsx(Fe,{debounceKey:"Catalog autosaver",mutate:t.mutate,isFetching:a,isError:o,data:n,getTouchList:Pn}),e.jsx(Qe,{touchList:s,isPending:t.isPending,label:"Catalog"})]})}const En=console.log.bind(console);function Rn(t){const n=u.useRef(new AbortController),a=v(),o=b({mutationFn:r=>An(t,r),onSuccess:(r,i)=>Mn({calendarId:t,result:r,original:i,queryClient:a}),onError:(r,i)=>Ln({error:r,calendarId:t,original:i,queryClient:a})});return b({retry:0,mutationKey:["event bundle",t],onMutate:r=>{n.current.abort(),n.current=new AbortController,En("🍢 should start bundle with events:",r.map(i=>i.id).join(", "))},mutationFn:r=>Promise.all(r.map(i=>o.mutateAsync({...i,signal:n.current.signal}))),onError:r=>{((r==null?void 0:r.status)===409||(r==null?void 0:r.status)===404)&&je("event error refetch",()=>{console.log("🍒 event bundle error requesting refetch..."),a.refetchQueries({queryKey:["views",t]})})}})}function O(t,n,a){Ct(t,n,o=>({...o,stored:a(o.stored)})),St(t,n)}function Mn({calendarId:t,result:n,original:a,queryClient:o}){var c;const s=(c=o.getQueryData(["primary cache",t]))==null?void 0:c.stored.find(l=>l.id===a.id);function r(l,d){return l.colorId===d.color_id&&l.summary===d.summary&&l.description===d.description&&l.startTime.toISOString()===d.start_time&&l.endTime.toISOString()===d.end_time}if(a.etag==="creating"){const l={...s,id:n.event_id,etag:n.etag,created:_(n.created)};r(s,n)&&delete l.unsaved,O(o,t,d=>d.map(h=>h.id===a.id?l:h));return}if(a.isDeleting){O(o,t,l=>l.filter(d=>d.id!==a.id));return}if(s.etag!==a.etag)return;let i={};s.unsaved===a.unsaved?i={id:a.id,summary:n[0].summary,description:n[0].description,startTime:_(n[0].start_time),endTime:_(n[0].end_time),colorId:n[0].color_id,etag:n[0].etag,stableKey:s.stableKey}:i={...s,etag:n[0].etag},O(o,t,l=>l.map(d=>d.id===a.id?i:d))}function Ln({calendarId:t,error:n,original:a,queryClient:o}){if(a.isDeleting&&n.status===404){O(o,t,s=>s.filter(r=>r.id!==a.id));return}}function An(t,n){const a="calendars",s=n.signal;return n.isDeleting?p(`${a}/events/${n.id}`,{method:"DELETE",body:{etag:n.etag},timeout:5e3,signal:s}):n.etag==="creating"?p(`${a}/${t}/events`,{method:"POST",body:{key:n.id,start_time:n.startTime.toISOString(),end_time:n.endTime.toISOString(),summary:n.summary,description:n.description,color_id:n.colorId},timeout:5e3,signal:s}):p(`${a}/events/${n.id}`,{method:"PUT",body:{etag:n.etag,start_time:n.startTime.toISOString(),end_time:n.endTime.toISOString(),summary:n.summary,description:n.description,color_id:n.colorId},timeout:5e3,signal:s})}const Fn=(...t)=>console.log("%cEventSync>","color:orange",...t);function Qn({id:t}){const{mutate:n,isPending:a}=Rn(t),{data:o}=te({queryKey:["primary cache",t],enabled:!1}),s=q(o==null?void 0:o.stored),r=u.useCallback(i=>q(i.getQueryData(["primary cache",t]).stored),[t]);return e.jsxs(e.Fragment,{children:[e.jsx(Fe,{debounceKey:`Event autosaver ${t}`,mutate:n,log:Fn,data:o,getTouchList:r}),e.jsx(Qe,{touchList:s,isPending:a,label:"Events"})]})}function On(){const t=H(),{data:n}=de(),a=_t();return console.log("cacheList was",a),e.jsx(x,{sx:{pointerEvents:"none",zIndex:4,position:t?"fixed":"absolute",right:0,bottom:0,mb:t?"4rem":void 0},children:n&&e.jsxs(e.Fragment,{children:[e.jsx(Tn,{}),a.map(o=>e.jsx(Qn,{id:o},o))]})})}const Oe=()=>console.warn("No navigation controller provided."),Z={current:Oe};function In(t){return Z.current(t)}function Nn(){const t=B();u.useEffect(()=>(console.log("⬆️ subscribing to nav control."),Z.current=t,()=>{Z.current=Oe,console.log("🔽 unsubscribing to nav control.")}),[t])}const Kn=t=>async()=>"unused";function Vn(){const t=H(),[n,a]=u.useState(!1),o=U();return Nn(),e.jsxs(oe.Provider,{value:a,children:[e.jsx(Dt,{}),e.jsx(ee,{className:"root-container",maxWidth:"lg",disableGutters:!0,sx:{height:"100vh",overflowX:t?void 0:"hidden"},children:e.jsxs(x,{sx:{height:"100%",display:"flex"},children:[e.jsx(wn,{expand:n}),e.jsxs("div",{style:{flexGrow:1,position:"relative"},children:[e.jsx(On,{}),e.jsx(Le,{tag:"views"}),o.state==="loading"&&e.jsx("div",{style:{zIndex:4,position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(21, 28, 50, 0.28)",display:"grid",placeItems:"center"},children:e.jsx(M,{color:"primary"})}),e.jsx(kt,{})]})]})})]})}function qn(){const n=Ye(),[a,o]=u.useState("Demo Account"),[s,r]=u.useState(" "),[i,c]=u.useState(!1),[l,d]=u.useState("123"),[h,C]=u.useState(!1),{data:j}=de(),g=B(),S=u.useRef(null),D=!1,k=v(),P=m=>{console.log("mutation success with data: ",m),k.invalidateQueries({queryKey:["catalog"]}),k.setQueryData(["heartbeat"],m),g("/catalog")},W=b({mutationFn:({email:m,password:X})=>(k.cancelQueries(),p("login",{timeout:5e3,method:"POST",body:{email:m.trim(),password:X}})),onSuccess:P,onError:m=>{m.status===403&&c(!0)}}),G=b({mutationFn:({email:m,password:X,name:Ie})=>(k.cancelQueries(),p("register",{timeout:5e3,method:"POST",body:{email:m.trim(),password:X,name:Ie.trim()}})),onSuccess:P,onError:m=>{(m.status===403||m.status===409)&&c(!0)}});return j?e.jsx(J,{to:"/catalog"}):e.jsx(ne,{elevation:1,sx:{py:6,px:2,minWidth:[240,300],maxWidth:450,ml:"auto",mr:"auto",mt:[0,6]},children:e.jsx("form",{onSubmit:m=>m.preventDefault(),children:e.jsxs(ee,{children:[e.jsx(f,{variant:"h4",component:"h2",sx:{mb:1},children:h?"Register":"Sign In"}),e.jsx(N,{sx:{mb:4}}),e.jsxs(ge,{children:[e.jsx(F,{sx:{mb:4},inputRef:S,label:"email",helperText:i&&h?"Already in use.":" ",variant:"standard",disabled:D,error:i,defaultValue:a,onChange:m=>{o(m.target.value),c(!1)}}),e.jsx(F,{sx:{mb:4},label:"password",variant:"standard",type:"password",helperText:i&&!h?"Invalid email or password.":" ",disabled:D,error:i,defaultValue:l,onChange:m=>{d(m.target.value),c(!1)}}),e.jsx(_e,{in:h,children:e.jsx(F,{sx:{mb:4,width:"100%"},label:"display name",variant:"standard",disabled:D,error:i,defaultValue:s,onChange:m=>{r(m.target.value)}})}),e.jsxs(ge,{spacing:3,children:[e.jsx($,{disabled:W.isPending||G.isPending,onClick:()=>{if(h)return G.mutate({email:a,password:l,name:s});W.mutate({email:a,password:l})},variant:h?"contained":"outlined",children:W.isPending||G.isPending?e.jsx(M,{size:"1.5rem"}):h?"Sign Up":"Sign In"}),e.jsx(N,{sx:{mb:3,mt:3,color:n.palette.divider},children:"OR"}),e.jsx($,{variant:h?"outlined":"contained",disabled:D,color:h?"primary":"secondary",onClick:()=>{h||S.current.focus(),C(m=>!m),c(!1)},children:h?"Back":"Register"})]})]})]})})})}function Bn(){return e.jsx(Q,{children:e.jsx(qn,{})})}function Un(){return v().getQueryData(["heartbeat"])?e.jsx(J,{to:"/catalog"}):e.jsx(J,{to:"/login"})}const ve=t=>{var n;console.log("🌍 global cache error handler:",t.status,t.message),(n=t.message)!=null&&n.includes("No identification")&&(console.log("❔ No ID"),T.setQueryData(["heartbeat"],null),T.invalidateQueries({queryKey:["heartbeat"]}),In("login"))},T=new lt({defaultOptions:{queries:{retry:pe},mutations:{retry:pe}},queryCache:new ct({onError:ve}),mutationCache:new dt({onError:ve})}),zn=$t([{path:"/",element:e.jsx(Vn,{}),loader:Kn(),errorElement:e.jsx(fe,{}),children:[{errorElement:e.jsx(fe,{}),children:[{index:!0,element:e.jsx(Un,{})},{path:"login",element:e.jsx(Bn,{})},{path:"catalog",element:e.jsx(yn,{}),loader:dn(T)},{path:"calendars/:id",element:e.jsx(Tt,{}),loader:Et(T)}]}]}]);Je.createRoot(document.getElementById("root")).render(e.jsx(Ze.StrictMode,{children:e.jsx(et,{client:T,children:e.jsx(tt,{theme:nt,children:e.jsx(at,{enableColorScheme:!0,children:e.jsx(Pt,{router:zn})})})})}));
