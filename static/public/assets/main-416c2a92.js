import"./_commonjsHelpers-9f0e44cc.js";import{g as Ne,a as Ve,s as qe,T as v,r as u,u as Ke,_ as Be,j as t,b as ze,c as He,d as Ue,C as ee,B as $,e as R,i as M,f as w,h as f,L as N,D as T,k as x,l as te,m as y,I as Q,P as ne,F as We,n as ae,o as O,p as Ge,q as xe,t as Xe,v as je,w as Ye,S as ge,x as Je,R as Ze,Q as et,y as tt,z as nt,A as at}from"./debounce-02451237.js";import{C as be,a as we,b as Ce,u as b,A as st,c as L,d as ot,S as V,e as rt,f as it,Q as lt,g as ct,M as dt}from"./AddCircleOutline-f0a69d24.js";import{u as B,a as ut,b as se,c as z,L as H,d as Se,e as q,f as mt,C as _e,g as ht,T as oe,h as xt,i as p,j as gt,k as pt,l as U,V as F,r as ft,m as vt,n as yt,D as jt,o as bt,p as wt,t as K,q as Ct,s as St,v as _t,F as Dt,O as kt,N as J,w as pe,x as $t,R as Pt,y as Tt,z as Et}from"./Calendar-d2c943dc.js";import{d as _}from"./utc-1e73b667.js";function Rt(e){return Ne("MuiAlertTitle",e)}Ve("MuiAlertTitle",["root"]);const Mt=["className"],Lt=e=>{const{classes:n}=e;return Ue({root:["root"]},Rt,n)},At=qe(v,{name:"MuiAlertTitle",slot:"Root",overridesResolver:(e,n)=>n.root})(({theme:e})=>({fontWeight:e.typography.fontWeightMedium,marginTop:-2})),Qt=u.forwardRef(function(n,a){const o=Ke({props:n,name:"MuiAlertTitle"}),{className:s}=o,r=Be(o,Mt),i=o,c=Lt(i);return t.jsx(At,ze({gutterBottom:!0,component:"div",ownerState:i,ref:a,className:He(c.root,s)},r))}),Ot=Qt;function fe(){const e=B(),n=ut();return console.error(n),t.jsx(ee,{maxWidth:"sm",children:t.jsxs(be,{variant:"outlined",sx:{mt:6},children:[t.jsx(v,{variant:"h5",sx:{backgroundColor:"#f205",p:"0.5rem"},children:"Unable to resolve request"}),t.jsxs(we,{children:[t.jsx("p",{children:"An error has occurred: "}),t.jsx("div",{style:{backgroundColor:"#111",padding:"0.5rem",borderRadius:"4px",wordWrap:"break-word",fontFamily:"monospace"},children:n.statusText||n.message})]}),t.jsx(Ce,{children:t.jsx($,{onClick:()=>e(-1),children:"Back"})})]})})}var re={},Ft=M;Object.defineProperty(re,"__esModule",{value:!0});var De=re.default=void 0,It=Ft(R()),Nt=t,Vt=(0,It.default)((0,Nt.jsx)("path",{d:"M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"}),"Home");De=re.default=Vt;var ie={},qt=M;Object.defineProperty(ie,"__esModule",{value:!0});var ke=ie.default=void 0,Kt=qt(R()),Bt=t,zt=(0,Kt.default)((0,Bt.jsx)("path",{d:"M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-7 2h2.5v12H13V6zm-2 12H8.5V6H11v12zM4 6h2.5v12H4V6zm16 12h-2.5V6H20v12z"}),"CalendarViewWeek");ke=ie.default=zt;var le={},Ht=M;Object.defineProperty(le,"__esModule",{value:!0});var $e=le.default=void 0,Ut=Ht(R()),Wt=t,Gt=(0,Ut.default)((0,Wt.jsx)("path",{d:"M3 17h18v2H3zm0-7h18v5H3zm0-4h18v2H3z"}),"CalendarViewDay");$e=le.default=Gt;function Pe({route:e,children:n}){const a=se(),o=z(),s=w(),r=a.pathname===e&&!o.location||o.location&&o.location.pathname===e,i=new URLSearchParams(o.location&&o.location.search||"v="),c=new URLSearchParams(a.search||"v="),l=i.get("v"),d=c.get("v"),h=r&&!l&&!d,C=o.location&&o.location.pathname===e&&!l,j=a.pathname===e&&!d;return t.jsx(H,{disablePadding:!0,children:t.jsx(Se,{component:q,to:e,sx:{backgroundColor:j?Ee:r?Te:void 0,boxShadow:(C||h)&&"4px 0 0 inset "+f(s.palette.primary.main,.53),pr:"0.25rem",color:f(s.palette.text.primary,r?1:.775)},children:n})})}const Te="#0116",Ee="#153244cc";function Xt({route:e,title:n}){const a=se(),o=z(),s=w(),[r]=mt(),i=r.has("d")?"&d="+r.get("d"):"",c=a.pathname===e&&!o.location||o.location&&o.location.pathname===e;return t.jsx(H,{disablePadding:!0,children:t.jsxs(N,{disablePadding:!0,sx:{color:f(s.palette.text.primary,c?1:.775),width:"100%",maxWidth:360,bgcolor:"background.paper",borderBottom:c?"1px solid #ffffff28":"1px solid #0008"},"aria-label":`Nested folder ${e}`,children:[c&&t.jsx(T,{}),t.jsx(Pe,{route:e,children:t.jsx(x,{sx:{textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap"},children:n})}),t.jsx(_e,{in:c,timeout:350,unmountOnExit:!0,children:t.jsxs(N,{disablePadding:!0,children:[t.jsx(Y,{to:`${e}?v=month${i}`,label:"Month",children:t.jsx(ht,{})}),t.jsx(Y,{to:`${e}?v=week${i}`,label:"Week",children:t.jsx(ke,{})}),t.jsx(Y,{to:`${e}?v=day${i}`,label:"Day",children:t.jsx($e,{})})]})})]})})}function Y({to:e="",label:n,children:a}){const o=w(),s=z(),r=se(),i=u.useContext(oe),c=e.split("?")[0],l=s.location&&s.location.pathname,d=r.pathname,h=new URLSearchParams(e.split("?")[1]||"v="),C=new URLSearchParams(s.location&&s.location.search||"v="),j=new URLSearchParams(r.search||"v="),g=h.get("v"),S=C.get("v"),D=j.get("v"),k=l===c&&g===S,P=c===d&&g===D;return t.jsx(H,{onClick:()=>i(!1),sx:{color:"inherit",boxShadow:(k||P&&!s.location)&&"4px 0 0 inset "+f(o.palette.primary.main,.53),backgroundColor:P?Ee:Te},disablePadding:!0,children:t.jsxs(Se,{component:q,to:e,sx:{pl:3,"&:hover":{backgroundColor:"#aef3"}},children:[t.jsx(xt,{sx:{minWidth:"48px"},children:a}),n]})})}var ce={},Yt=M;Object.defineProperty(ce,"__esModule",{value:!0});var Re=ce.default=void 0,Jt=Yt(R()),Zt=t,en=(0,Jt.default)((0,Zt.jsx)("path",{d:"m17 7-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"}),"Logout");Re=ce.default=en;function de(){return te({staleTime:2*60*1e3,queryKey:["heartbeat"],queryFn:({signal:e})=>p("me",{signal:e})})}function tn({children:e}){var l;const n=y(),a=B(),o=w(),s=b({mutationFn:()=>(n.cancelQueries(),p("login",{timeout:5e3,method:"POST",body:{email:"Demo Account",password:"123"}})),onSuccess:d=>{console.log("mutation success with data: ",d),n.invalidateQueries({queryKey:["catalog"]}),n.setQueryData(["heartbeat"],d),a("/catalog")}}),r=b({mutationFn:()=>p("login",{timeout:5e3,method:"DELETE"}),onSuccess:d=>{console.log("logout mutation yielded ",d),n.cancelQueries(),n.setQueryData(["heartbeat"],null),a("/login")}}),i=de();let c=t.jsx(x,{sx:{mx:"auto"},children:t.jsx(L,{size:"1.75rem"})});return!s.isPending&&!r.isPending&&(c=(l=i.data)!=null&&l.name?t.jsxs(t.Fragment,{children:[t.jsx(st,{sx:{bgcolor:o.palette.primary.main,mr:1,ml:1,width:"30px",height:"30px"},children:i.data.name[0]}),t.jsx("span",{style:{overflow:"hidden",flexGrow:1,whiteSpace:"nowrap",textOverflow:"ellipsis",verticalAlign:"center"},children:i.data.name}),t.jsx(Q,{onClick:r.mutate,children:t.jsx(Re,{})})]}):t.jsx($,{variant:"contained",onClick:s.mutate,sx:{mx:"auto"},children:"Login Sample User"})),t.jsxs(t.Fragment,{children:[i.data&&e,t.jsx(N,{disablePadding:!0,sx:{mt:"auto"},children:t.jsx(H,{sx:{backgroundColor:"#0002",py:1,borderTop:"1px solid #0004"},disablePadding:!0,children:t.jsx(x,{sx:{width:"100%",display:"flex",height:"2.5rem",alignItems:"center"},children:c})})})]})}var ue={},nn=M;Object.defineProperty(ue,"__esModule",{value:!0});var Me=ue.default=void 0,an=nn(R()),sn=t,on=(0,an.default)((0,sn.jsx)("path",{d:"M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"}),"Share");Me=ue.default=on;function rn({query:e}){const n=w();if(e.isPending)return t.jsx(x,{sx:{boxShadow:"0 0 1rem inset "+f(n.palette.primary.main,.08),height:"100%",display:"grid",placeContent:"center"},children:t.jsx(L,{})});if(e.error)return t.jsx(x,{sx:{boxShadow:"0 0 1rem inset "+f(n.palette.primary.main,.08),height:"100%",display:"grid",placeContent:"center"},children:t.jsxs(ot,{severity:"error",sx:{border:"1px solid "+f(n.palette.error.main,.08)},action:t.jsx($,{sx:{mt:"auto"},onClick:e.refetch,children:"Retry"}),children:[t.jsx(Ot,{children:"Error"}),e.error.message]})})}function ln(e){return e.isPending||e.error?t.jsx(rn,{query:e}):!1}function Le({tag:e}){const{palette:n}=w(),[a,o]=u.useState(!1),[s,r]=u.useState(0),[i,c]=u.useState(0),l=gt(e);return u.useEffect(()=>{l.length&&(o(!0),c(Math.random()),r(l.length),pt(e))},[l,e]),t.jsx(cn,{open:a,children:t.jsx(ne,{elevation:0,sx:{px:2,py:1.25},children:t.jsx(v,{variant:"subtitle2",color:f(n.text.primary,.85),children:`Updated with ${s} remote change${s>1?"s":""}.`})})},i)}function cn({sx:e,open:n,children:a}){const[o,s]=u.useState(!0),r=U();return u.useEffect(()=>{const i=setTimeout(()=>{s(!1)},3e3);return()=>clearTimeout(i)},[]),n&&t.jsx(x,{sx:{pointerEvents:"none",zIndex:4,right:0,bottom:0,mr:3,position:r?"fixed":"absolute",mb:r?"4rem":"1rem",...e},children:t.jsx(We,{in:o,timeout:{enter:250,exit:1700},children:a})})}function Ae(e){return{staleTime:1*60*1e3,queryKey:["catalog"],queryFn:async()=>{const n=await p("calendars"),a=e.getQueryData(["catalog"])??[];return ft({localData:a,serverData:n,key:"calendar_id",tag:"calendars"})}}}const dn=e=>({request:n,params:a})=>(e.prefetchQuery(Ae(e)),"unused");function A({sx:e}){return t.jsxs(x,{sx:e,children:[t.jsx(V,{variant:"rounded",height:"2rem",animation:"wave",sx:{mb:1}}),t.jsx(V,{variant:"rounded",sx:{height:"calc(100% - 3rem)"}})]})}function ve({children:e}){return t.jsx(x,{sx:{gridAutoFlow:"row",display:"grid",width:"100%",padding:2,gap:2,gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gridAutoRows:"300px"},children:e})}function me({sx:e,children:n}){return t.jsx(be,{sx:{display:"flex",flexDirection:"column",boxShadow:"0.25rem 0.25rem 0.35rem #0006",...e},children:n})}function un(){const e=mn(),[n,a]=u.useState(!1);return t.jsx(me,{children:t.jsxs(rt,{disabled:n,onClick:()=>{a(!0),setTimeout(()=>a(!1),500),e()},sx:{display:"flex",flexDirection:"column",flexGrow:1,opacity:n?.3:1},children:[t.jsx(it,{sx:{width:"80px",height:"80px"}}),t.jsx(v,{variant:"subtitle1",children:"New Calendar"})]})})}function mn(){const e=y(),[n,a]=u.useState(()=>o());function o(){return String(Math.floor(Math.random()*1e9))}return()=>{const s={summary:"New Calendar",etag:"creating",calendar_id:n,stableKey:n};console.log("creating with idemKey: ",s.calendar_id),e.setQueryData(["catalog"],i=>[...i,s]);const r=o();console.log("setting new idem key to ",r),a(r)}}function hn(e){const n=y();return()=>{n.setQueryData(["catalog"],a=>a.map(o=>o.calendar_id===e?{...o,isDeleting:!0,unsaved:Date.now()}:o))}}function xn(e){const n=y();return a=>{n.setQueryData(["catalog"],o=>o.map(s=>s.calendar_id===e?{...s,...a,unsaved:Date.now()}:s))}}const gn=ae`
  from {
    box-shadow: 0 0 3rem #afff inset;
  }
  to {
    box-shadow: 0 0 3rem #aff0 inset;
  }
`,pn=ae`
from {
  opacity: 1.0;
  box-shadow: 0 0 0px #0000 inset;
}
to {
  opacity: 0.0;
  box-shadow: 0 0 200px #000f inset;
}
`;function fn({calendar:e,children:n}){const a=hn(e.calendar_id),o=xn(e.calendar_id),s=w(),[r,i]=u.useState(!1),c=e.etag==="creating",l=u.useRef(null),h=_().diff(e.created)<1e3,C=e.isDeleting&&e.unsaved-Date.now()<1e3;u.useEffect(()=>{var g,S;r&&((g=l.current)==null||g.focus(),(S=l.current)==null||S.select())},[r]);let j;return h&&(j=`${gn} 1s ease`),C&&(j=`${pn} 1s ease`),t.jsxs(me,{sx:{opacity:e.isDeleting?.5:void 0,animation:j},children:[t.jsx(x,{component:r||c?"div":q,to:"/calendars/"+e.calendar_id,sx:{color:"inherit",textDecoration:"none",bgcolor:f(s.palette.primary.dark,.3),"&:hover":{bgcolor:!c&&f(s.palette.primary.dark,.7)}},children:t.jsx(x,{sx:{height:"4rem",px:r?0:"12px",pt:r?0:"25px"},children:r?t.jsx(O,{sx:{width:"100%"},variant:"filled",inputRef:l,defaultValue:e.summary||"Untitled",onClick:g=>{r&&(g.preventDefault(),console.log("TextField preventDefault"))},onKeyUp:g=>{g.key==="Enter"&&l.current.blur()},onBlur:g=>{console.log("☁️ Blur: e.target.value=",g.target.value),o({summary:g.target.value}),i(!1)}}):t.jsx(x,{sx:{textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap"},children:e.summary})})}),t.jsx(we,{sx:{flexGrow:1,width:"100%"},children:n}),t.jsxs(Ce,{children:[t.jsx($,{disabled:c,component:q,to:`/calendars/${e.calendar_id}`,children:"Open"}),t.jsxs(x,{ml:"auto",children:[t.jsx(Q,{disabled:c,"aria-label":"Share",onClick:()=>console.log("share placeholder"),children:t.jsx(Me,{sx:{opacity:.9}})}),t.jsx(Q,{"aria-label":"Rename",onClick:()=>{console.log("renaming..."),i(!0)},children:t.jsx(vt,{sx:{opacity:.9}})}),t.jsx(Q,{"aria-label":"Delete",disabled:e.isDeleting,onClick:()=>a(e.calendar_id),children:t.jsx(Ge,{sx:{opacity:.9}})})]})]})]})}function he(){const e=y();return te(Ae(e))}function vn(){var r,i,c;const e=he(),n=ln(e),a=t.jsx(yt,{children:t.jsx(v,{variant:"h6",component:"span",children:"My Calendars"})});if(e.isPending||e.isError&&e.isFetching||!e.data&&e.isFetching)return t.jsxs(F,{children:[a,t.jsxs(ve,{children:[t.jsx(A,{sx:{opacity:.8}}),t.jsx(A,{sx:{opacity:.45}}),t.jsx(A,{sx:{opacity:.225}}),t.jsx(A,{sx:{opacity:.1}})]})]});if(e.error||!e.data)return t.jsxs(F,{children:[a,n]});let o=[];((r=e.data)==null?void 0:r.length)<3&&(o=new Array(3-e.data.length).fill(null).map((l,d)=>t.jsx(me,{sx:{opacity:0}},d)));const s=_();return t.jsxs(F,{children:[a,t.jsxs(ve,{children:[(c=(i=e.data)==null?void 0:i.map)==null?void 0:c.call(i,l=>t.jsx(fn,{calendar:l,children:t.jsxs(v,{variant:"body2",sx:{opacity:.5},children:["Created: ",_(l.created).from(s),t.jsx("br",{}),"Updated: ",_(l.updated).from(s),t.jsx("br",{})]})},l.stableKey??l.calendar_id)),t.jsx(un,{}),o]}),t.jsx(Le,{tag:"calendars"})]})}function yn(){const e=Array(5).fill(0);return t.jsx(x,{sx:{flexGrow:1,overflowY:"auto",overflowX:"hidden",p:2,display:"flex",flexDirection:"column"},children:e.map((n,a)=>t.jsxs("div",{style:{display:"flex",alignItems:"center",height:"40px"},children:[t.jsx(V,{variant:"rounded",width:16,height:16,sx:{display:"inline-block",mr:1}}),t.jsx(V,{sx:{display:"inline-block",flexGrow:1}})]},a))})}function jn(){var n;const e=he();return e.isPending?t.jsx(yn,{}):t.jsx(x,{sx:{flexGrow:1,overflowY:"auto",overflowX:"hidden"},children:t.jsxs(N,{disablePadding:!0,children:[e.data&&t.jsxs(Pe,{route:"/catalog",children:[t.jsx(De,{sx:{mr:1}}),"All Calendars"]}),(n=e.data)==null?void 0:n.map(a=>{const o=a.stableKey??a.calendar_id;if(!(a.isDeleting||a.etag==="creating"))return t.jsx(Xt,{route:`/calendars/${a.calendar_id}`,title:a.summary},o)})]})})}function bn(){return t.jsxs(t.Fragment,{children:[t.jsxs(x,{sx:{height:"64px",px:2,py:2,backgroundImage:`url(${bt})`,backgroundColor:"#00182575"},children:[t.jsx(wt,{sx:{transform:"translateY(5px)",mr:1,opacity:.75}}),t.jsx(v,{variant:"h6",component:"span",sx:{fontWeight:500,textShadow:"2px -1px 4px #000"},children:"Clear"}),t.jsx(v,{variant:"h6",component:"span",sx:{fontWeight:300,opacity:.9,textShadow:"1px -1px 4px #000"},children:"Time"})]}),t.jsx(T,{})]})}function wn({width:e="240px",expand:n}){const a=w(),o=U(),s=u.useContext(oe),r=t.jsxs(t.Fragment,{children:[t.jsx(bn,{}),t.jsx(tn,{children:t.jsx(jn,{})})]});return o?t.jsxs(jt,{open:n,onClose:()=>s(!1),sx:{"& .MuiDrawer-paper":{width:e,flexShrink:0,borderRight:`1px solid ${a.palette.divider}`,backgroundImage:"unset",backgroundColor:"#101b1d"}},children:[r,t.jsx(T,{})]}):t.jsx(ne,{component:"nav",elevation:0,sx:{display:"flex",flexDirection:"column",width:e,flexShrink:0,borderRight:`1px solid ${a.palette.divider}`,borderLeft:`1px solid ${a.palette.divider}`},children:r})}const Cn=()=>{};function Qe({mutate:e,data:n,isFetching:a,isError:o,getTouchList:s,debounceKey:r,log:i=Cn}){const c=u.useRef(1),l=y();u.useEffect(()=>{xe(r,()=>{const d=s(l);c.current++,d.length>0?(i(`♻️ Autosaving... (check # ${c.current})`),e(d)):i(`✅ Autosaver clean. (check # ${c.current})`)},4e3)()},[n,l,e,i,s,r]),u.useEffect(()=>{if(!a&&!o){if(i(`👁️ fetch success. ${Math.floor(Math.random()*1e9)}`),Xe(r)){i("Autosaver already ran or running.");return}xe(r,()=>{const d=s(l);d.length>0?(i("♻️👁️ Fetch sentinel syncing..."),e(d)):i("✅👁️ Fetch sentinel clean.")},4e3)()}},[l,e,a,o,i,s,r])}const Sn=ae`
  0% {
    opacity: 1.0;
  }
  50% {
    opacity: 0.0;
  }
  100% {
    opacity: 0.0;
  }
`;function Oe({touchList:e,isPending:n,label:a}){const[o,s]=u.useState(!1),r=e.length===0;u.useEffect(()=>{if(!r)return s(!0);const l=setTimeout(()=>{s(!1)},3e3);return()=>{clearTimeout(l)}},[r]);let i="success.main",c=`${a} saved.`;return e.length>0&&(i="info.main",c=`Unsaved (${e.length})`),n&&e.length>0&&(i="warning.main",c=`Saving... (${e.length})`),t.jsxs(x,{sx:{backgroundColor:"#222a",borderRadius:"4px",display:o?"flex":"none",justifyContent:"end",padding:"0.5rem 0.75rem",mr:2,mb:2,animation:r&&`${Sn} 2s ease 2s`},children:[t.jsx(v,{variant:"subtitle2",color:i,children:c}),n&&t.jsx(L,{size:"18px",sx:{ml:"1rem",color:i,alignSelf:"center"}})]})}function _n(){const e=u.useRef(new AbortController),n=y(),a=b({onMutate:s=>(console.log("initiating item mutation with variables=",s),{...s}),mutationFn:s=>(console.log("fetching item mutation with unsaved=",s.unsaved),$n(s)),onSuccess:(s,r,i)=>{console.log("item success, variables=",r),console.log("and context=",i),kn({result:s,original:r,queryClient:n})},onError:(s,r,i)=>{console.log("item error, unsaved=",r.unsaved),console.log("and context=",i),Dn({error:s,original:r,queryClient:n})}});return b({retry:0,mutationKey:["catalog bundle"],onMutate:s=>{e.current.abort(),e.current=new AbortController,console.log(`🟧 Starting bundle mutation with calendars (${s.length})`,s.map(r=>r.calendar_id).join(", "),"and variables=",...s)},mutationFn:s=>Promise.all(s.map(r=>a.mutateAsync({...r,signal:e.current.signal}))),onError:s=>{(s==null?void 0:s.status)===409&&(console.log(`⛔ Bundle mutation resulted in ${s.status}. Backoff-refetching...`),je("catalog conflict refetch",()=>{console.log("⛔ Bundle refetching."),n.refetchQueries({queryKey:["catalog"]})}))}})}function Dn({error:e,original:n,queryClient:a}){if(n.isDeleting&&e.status===404){a.setQueryData(["catalog"],o=>o.filter(s=>s.calendar_id!==n.calendar_id));return}}function kn({result:e,original:n,queryClient:a}){const o=a.getQueryData(["catalog"]).find(i=>i.calendar_id===n.calendar_id);function s(i,c){return i.summary===c.summary}if(n.etag==="creating"){const i={...o,primary_author_id:e.primary_author_id,etag:e.etag,created:e.created,updated:e.updated,calendar_id:e.calendar_id};s(e,o)?(console.log("🔗 content equivalent, clearing unsaved:",n.unsaved),delete i.unsaved):console.log("✖️ content mismatch:",o==null?void 0:o.summary,e.summary),a.setQueryData(["catalog"],c=>c.map(l=>l.calendar_id===n.calendar_id?i:l));return}if(n.isDeleting){a.setQueryData(["catalog"],i=>i.filter(c=>c.calendar_id!==n.calendar_id));return}if(o.etag!==n.etag)return;let r={};o.unsaved===n.unsaved?r={...e[0],stableKey:o.stableKey}:r={...o,etag:e[0].etag},a.setQueryData(["catalog"],i=>i.map(c=>c.calendar_id===n.calendar_id?r:c))}function $n(e){const n="calendars",o=e.signal,s={signal:void 0,unsaved:void 0,created:void 0,updated:void 0,originTag:void 0,stableKey:void 0,primary_author_id:void 0};return e.isDeleting?p(`${n}/${e.calendar_id}`,{method:"DELETE",body:{etag:e.etag},timeout:5e3,signal:o}):e.etag==="creating"?p(n,{method:"POST",body:{...e,...s,etag:void 0,key:e.calendar_id},timeout:5e3,signal:o}):p(`${n}/${e.calendar_id}`,{method:"PUT",body:{...e,...s},timeout:5e3,signal:o})}const Pn=e=>K(e.getQueryData(["catalog"]));function Tn(){const e=_n(),{data:n,isFetching:a,isError:o}=he(),s=K(n);return t.jsxs(t.Fragment,{children:[t.jsx(Qe,{debounceKey:"Catalog autosaver",mutate:e.mutate,isFetching:a,isError:o,data:n,getTouchList:Pn}),t.jsx(Oe,{touchList:s,isPending:e.isPending,label:"Catalog"})]})}const En=console.log.bind(console);function Rn(e){const n=u.useRef(new AbortController),a=y(),o=b({mutationFn:r=>An(e,r),onSuccess:(r,i)=>Mn({calendarId:e,result:r,original:i,queryClient:a}),onError:(r,i)=>Ln({error:r,calendarId:e,original:i,queryClient:a})});return b({retry:0,mutationKey:["event bundle",e],onMutate:r=>{n.current.abort(),n.current=new AbortController,En("🍢 should start bundle with events:",r.map(i=>i.id).join(", "))},mutationFn:r=>Promise.all(r.map(i=>o.mutateAsync({...i,signal:n.current.signal}))),onError:r=>{((r==null?void 0:r.status)===409||(r==null?void 0:r.status)===404)&&je("event error refetch",()=>{console.log("🍒 event bundle error requesting refetch..."),a.refetchQueries({queryKey:["views",e]})})}})}function I(e,n,a){Ct(e,n,o=>({...o,stored:a(o.stored)})),St(e,n)}function Mn({calendarId:e,result:n,original:a,queryClient:o}){var c;const s=(c=o.getQueryData(["primary cache",e]))==null?void 0:c.stored.find(l=>l.id===a.id);function r(l,d){return l.colorId===d.color_id&&l.summary===d.summary&&l.description===d.description&&l.startTime.toISOString()===d.start_time&&l.endTime.toISOString()===d.end_time}if(a.etag==="creating"){const l={...s,id:n.event_id,etag:n.etag,created:_(n.created)};r(s,n)&&delete l.unsaved,I(o,e,d=>d.map(h=>h.id===a.id?l:h));return}if(a.isDeleting){I(o,e,l=>l.filter(d=>d.id!==a.id));return}if(s.etag!==a.etag)return;let i={};s.unsaved===a.unsaved?i={id:a.id,summary:n[0].summary,description:n[0].description,startTime:_(n[0].start_time),endTime:_(n[0].end_time),colorId:n[0].color_id,etag:n[0].etag,stableKey:s.stableKey}:i={...s,etag:n[0].etag},I(o,e,l=>l.map(d=>d.id===a.id?i:d))}function Ln({calendarId:e,error:n,original:a,queryClient:o}){if(a.isDeleting&&n.status===404){I(o,e,s=>s.filter(r=>r.id!==a.id));return}}function An(e,n){const a="calendars",s=n.signal;return n.isDeleting?p(`${a}/events/${n.id}`,{method:"DELETE",body:{etag:n.etag},timeout:5e3,signal:s}):n.etag==="creating"?p(`${a}/${e}/events`,{method:"POST",body:{key:n.id,start_time:n.startTime.toISOString(),end_time:n.endTime.toISOString(),summary:n.summary,description:n.description,color_id:n.colorId},timeout:5e3,signal:s}):p(`${a}/events/${n.id}`,{method:"PUT",body:{etag:n.etag,start_time:n.startTime.toISOString(),end_time:n.endTime.toISOString(),summary:n.summary,description:n.description,color_id:n.colorId},timeout:5e3,signal:s})}const Qn=(...e)=>console.log("%cEventSync>","color:orange",...e);function On({id:e}){const{mutate:n,isPending:a}=Rn(e),{data:o}=te({queryKey:["primary cache",e],enabled:!1}),s=K(o==null?void 0:o.stored),r=u.useCallback(i=>K(i.getQueryData(["primary cache",e]).stored),[e]);return t.jsxs(t.Fragment,{children:[t.jsx(Qe,{debounceKey:`Event autosaver ${e}`,mutate:n,log:Qn,data:o,getTouchList:r}),t.jsx(Oe,{touchList:s,isPending:a,label:"Events"})]})}function Fn(){const e=U(),{data:n}=de(),a=_t();return console.log("cacheList was",a),t.jsx(x,{sx:{pointerEvents:"none",zIndex:4,position:e?"fixed":"absolute",right:0,bottom:0,mb:e?"4rem":void 0},children:n&&t.jsxs(t.Fragment,{children:[t.jsx(Tn,{}),a.map(o=>t.jsx(On,{id:o},o))]})})}const Fe=()=>console.warn("No navigation controller provided."),Z={current:Fe};function In(e){return Z.current(e)}function Nn(){const e=B();u.useEffect(()=>(console.log("⬆️ subscribing to nav control."),Z.current=e,()=>{Z.current=Fe,console.log("🔽 unsubscribing to nav control.")}),[e])}const Vn=e=>async()=>"unused";function qn(){const e=U(),[n,a]=u.useState(!1),o=z();return Nn(),t.jsxs(oe.Provider,{value:a,children:[t.jsx(Dt,{}),t.jsx(ee,{className:"root-container",maxWidth:"lg",disableGutters:!0,sx:{height:"100vh",overflowX:e?void 0:"hidden"},children:t.jsxs(x,{sx:{height:"100%",display:"flex"},children:[t.jsx(wn,{expand:n}),t.jsxs("div",{style:{flexGrow:1,position:"relative"},children:[t.jsx(Fn,{}),t.jsx(Le,{tag:"views"}),o.state==="loading"&&t.jsx("div",{style:{zIndex:4,position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(21, 28, 50, 0.28)",display:"grid",placeItems:"center"},children:t.jsx(L,{color:"primary"})}),t.jsx(kt,{})]})]})})]})}function Kn(){const n=Ye(),[a,o]=u.useState("Demo Account"),[s,r]=u.useState(" "),[i,c]=u.useState(!1),[l,d]=u.useState("123"),[h,C]=u.useState(!1),{data:j}=de(),g=B(),S=u.useRef(null),D=!1,k=y(),P=m=>{console.log("mutation success with data: ",m),k.invalidateQueries({queryKey:["catalog"]}),k.setQueryData(["heartbeat"],m),g("/catalog")},W=b({mutationFn:({email:m,password:X})=>(k.cancelQueries(),p("login",{timeout:5e3,method:"POST",body:{email:m.trim(),password:X}})),onSuccess:P,onError:m=>{m.status===403&&c(!0)}}),G=b({mutationFn:({email:m,password:X,name:Ie})=>(k.cancelQueries(),p("register",{timeout:5e3,method:"POST",body:{email:m.trim(),password:X,name:Ie.trim()}})),onSuccess:P,onError:m=>{(m.status===403||m.status===409)&&c(!0)}});return j?t.jsx(J,{to:"/catalog"}):t.jsx(ne,{elevation:1,sx:{py:6,px:2,minWidth:[240,300],maxWidth:450,ml:"auto",mr:"auto",mt:[0,6]},children:t.jsx("form",{onSubmit:m=>m.preventDefault(),children:t.jsxs(ee,{children:[t.jsx(v,{variant:"h4",component:"h2",sx:{mb:1},children:h?"Register":"Sign In"}),t.jsx(T,{sx:{mb:4}}),t.jsxs(ge,{children:[t.jsx(O,{sx:{mb:4},inputRef:S,label:"email",helperText:i&&h?"Already in use.":" ",variant:"standard",disabled:D,error:i,defaultValue:a,onChange:m=>{o(m.target.value),c(!1)}}),t.jsx(O,{sx:{mb:4},label:"password",variant:"standard",type:"password",helperText:i&&!h?"Invalid email or password.":" ",disabled:D,error:i,defaultValue:l,onChange:m=>{d(m.target.value),c(!1)}}),t.jsx(_e,{in:h,children:t.jsx(O,{sx:{mb:4,width:"100%"},label:"display name",variant:"standard",disabled:D,error:i,defaultValue:s,onChange:m=>{r(m.target.value)}})}),t.jsxs(ge,{spacing:3,children:[t.jsx($,{disabled:W.isPending||G.isPending,onClick:()=>{if(h)return G.mutate({email:a,password:l,name:s});W.mutate({email:a,password:l})},variant:h?"contained":"outlined",children:W.isPending||G.isPending?t.jsx(L,{size:"1.5rem"}):h?"Sign Up":"Sign In"}),t.jsx(T,{sx:{mb:3,mt:3,color:n.palette.divider},children:"OR"}),t.jsx($,{variant:h?"outlined":"contained",disabled:D,color:h?"primary":"secondary",onClick:()=>{h||S.current.focus(),C(m=>!m),c(!1)},children:h?"Back":"Register"})]})]})]})})})}function Bn(){return t.jsx(F,{children:t.jsx(Kn,{})})}function zn(){return y().getQueryData(["heartbeat"])?t.jsx(J,{to:"/catalog"}):t.jsx(J,{to:"/login"})}const ye=e=>{var n;console.log("🌍 global cache error handler:",e.status,e.message),(n=e.message)!=null&&n.includes("No identification")&&(console.log("❔ No ID"),E.setQueryData(["heartbeat"],null),E.invalidateQueries({queryKey:["heartbeat"]}),In("login"))},E=new lt({defaultOptions:{queries:{retry:pe},mutations:{retry:pe}},queryCache:new ct({onError:ye}),mutationCache:new dt({onError:ye})}),Hn=$t([{path:"/",element:t.jsx(qn,{}),loader:Vn(),errorElement:t.jsx(fe,{}),children:[{errorElement:t.jsx(fe,{}),children:[{index:!0,element:t.jsx(zn,{})},{path:"login",element:t.jsx(Bn,{})},{path:"catalog",element:t.jsx(vn,{}),loader:dn(E)},{path:"calendars/:id",element:t.jsx(Tt,{}),loader:Et(E)}]}]}]);Je.createRoot(document.getElementById("root")).render(t.jsx(Ze.StrictMode,{children:t.jsx(et,{client:E,children:t.jsx(tt,{theme:nt,children:t.jsx(at,{enableColorScheme:!0,children:t.jsx(Pt,{router:Hn})})})})}));
